{% extends "base.html" %}
{% block title %}Video Call with Dr. {{ doctor_name }}{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src='https://meet.jit.si/external_api.js'></script>
<style>
    body {
        padding: 0;
        margin: 0;
        overflow: hidden;
        height: 100vh;
    }
    .container {
        padding: 0;
        margin: 0;
        width: 100vw;
        height: 100vh;
        position: relative;
    }
    #jitsiContainer {
        width: 100%;
        height: 100%;
        background: #1a1a1a;
    }
    .controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        gap: 10px;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .button {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .end-call {
        background: #e74c3c;
        color: white;
    }
    .end-call:hover {
        background: #c0392b;
    }
    .appointment-info {
        background: white;
        color: #2d3748;
    }
    .appointment-info:hover {
        background: #f7fafc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="jitsiContainer"></div>
    <div class="controls">
        <button class="button appointment-info">
            üïí {{ appointment_time }}
        </button>
        <button class="button end-call" onclick="window.location.href='{{ url_for('dashboard_patient_view' if session.user.role == 'patient' else 'dashboard_doctor_view') }}'">
            ‚ùå End Call
        </button>
    </div>
</div>

<script>
    const domain = 'meet.jit.si';
    const options = {
        roomName: '{{ room_id }}',
        width: '100%',
        height: '100%',
        parentNode: document.querySelector('#jitsiContainer'),
        userInfo: {
            displayName: '{{ session.user.role|title }}: {{ session.user.name }}'
        },
        configOverwrite: {
            prejoinPageEnabled: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            defaultLanguage: 'en'
        },
        interfaceConfigOverwrite: {
            SHOW_CHROME_EXTENSION_BANNER: false,
            MOBILE_APP_PROMO: false,
            DISPLAY_WELCOME_PAGE_CONTENT: false,
            DISPLAY_WELCOME_PAGE_TOOLBAR_ADDITIONAL_CONTENT: false,
            TOOLBAR_BUTTONS: [
                'microphone', 'camera', 'desktop', 'chat',
                'raisehand', 'settings', 'hangup'
            ]
        }
    };
    const api = new JitsiMeetExternalAPI(domain, options);
    
    // Handle hangup event
    api.addEventListeners({
        readyToClose: () => {
            window.location.href = '{{ url_for('dashboard_patient_view' if session.user.role == 'patient' else 'dashboard_doctor_view') }}';
        }
    });
</script>
{% endblock %}
